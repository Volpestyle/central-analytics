---
// Dashboard Page with Authentication Protection
import Layout from '../layouts/Layout.astro';
import { DashboardLayout } from '../components/DashboardLayout';
---

<Layout title="Central Analytics Dashboard">
  <div id="dashboard-root"></div>
</Layout>

<script>
  import React from 'react';
  import ReactDOM from 'react-dom/client';
  import { DashboardLayout } from '../components/DashboardLayout';
  import useAuthStore from '../stores/auth.store';

  // Check authentication
  const checkAuth = async () => {
    const state = useAuthStore.getState();

    // Initialize auth if not already done
    if (!state.isAuthenticated && !state.isLoading) {
      await state.initializeAuth();
    }

    // Redirect if not authenticated
    if (!state.isAuthenticated) {
      window.location.href = '/';
      return false;
    }

    return true;
  };

  // Render dashboard
  const renderDashboard = () => {
    const root = document.getElementById('dashboard-root');
    if (!root) return;

    const DashboardContent = () => {
      const profile = useAuthStore((state) => state.profile);

      return React.createElement(DashboardLayout, null,
        React.createElement('div', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8' },
          React.createElement('div', { className: 'bg-apple-gray-950 rounded-2xl p-8' },
            React.createElement('h2', { className: 'text-2xl font-bold text-white mb-4' }, 'Welcome to Central Analytics'),
            React.createElement('p', { className: 'text-apple-gray-400 mb-6' },
              `Hello ${profile?.firstName || 'User'}, you're successfully authenticated using iOS 26 biometric security.`
            ),
            React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-6' },
              // Placeholder cards for dashboard metrics
              React.createElement('div', { className: 'bg-apple-gray-900 rounded-xl p-6' },
                React.createElement('h3', { className: 'text-sm font-medium text-apple-gray-400 mb-2' }, 'Total Users'),
                React.createElement('p', { className: 'text-3xl font-bold text-white' }, '1,234'),
                React.createElement('p', { className: 'text-sm text-green-400 mt-2' }, '+12.5% from last month')
              ),
              React.createElement('div', { className: 'bg-apple-gray-900 rounded-xl p-6' },
                React.createElement('h3', { className: 'text-sm font-medium text-apple-gray-400 mb-2' }, 'Revenue'),
                React.createElement('p', { className: 'text-3xl font-bold text-white' }, '$45.2K'),
                React.createElement('p', { className: 'text-sm text-green-400 mt-2' }, '+8.3% from last month')
              ),
              React.createElement('div', { className: 'bg-apple-gray-900 rounded-xl p-6' },
                React.createElement('h3', { className: 'text-sm font-medium text-apple-gray-400 mb-2' }, 'Active Sessions'),
                React.createElement('p', { className: 'text-3xl font-bold text-white' }, '892'),
                React.createElement('p', { className: 'text-sm text-apple-gray-500 mt-2' }, 'Real-time')
              )
            ),
            React.createElement('div', { className: 'mt-8 p-4 bg-apple-gray-900 rounded-lg' },
              React.createElement('p', { className: 'text-xs text-apple-gray-500 text-center' },
                'Dashboard features are being developed. Authentication system is fully functional with Face ID, Touch ID, and 2FA support.'
              )
            )
          )
        )
      );
    };

    const reactRoot = ReactDOM.createRoot(root);
    reactRoot.render(React.createElement(DashboardContent));
  };

  // Initialize on load
  window.addEventListener('load', async () => {
    const isAuthenticated = await checkAuth();
    if (isAuthenticated) {
      renderDashboard();
    }
  });

  // Subscribe to auth changes
  useAuthStore.subscribe((state) => {
    if (!state.isAuthenticated) {
      window.location.href = '/';
    }
  });
</script>